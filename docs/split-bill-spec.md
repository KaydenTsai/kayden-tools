# 拆帳工具規格書

## 概述

一個用於計算團體消費分攤的工具，適用於旅遊、聚餐等多人共同消費的場景。

---

## 核心功能

### 1. 帳單管理
- 建立多筆獨立的帳單紀錄
- 每筆帳單有獨立的成員、消費紀錄
- 支援切換不同帳單

### 2. 成員管理
- 新增/刪除成員
- 成員以名稱識別

### 3. 消費紀錄
- 記錄每筆消費的：
  - **名稱**：消費項目名稱
  - **金額**：消費金額
  - **付款人**：實際付錢的人（單選）
  - **參與者**：需要分攤這筆消費的人（多選）
- 支援「A 幫 B/C 付款」情境：付款人不在參與者名單內

### 4. 服務費
- 帳單層級設定服務費百分比
- 預設 0%，可自由調整
- 動態套用：修改服務費後自動重新計算，不需重新輸入消費
- 計算方式：每筆消費金額 × (1 + 服務費%)

### 5. 結算計算
- 計算每人應付總額
- 計算每人實付總額
- 產生最佳化轉帳清單（誰該付給誰多少錢）
- 提供驗算結果，確認計算正確性

### 6. 結清標記
- 針對每筆轉帳（A → B $xxx）可標記為已結清
- 簡易勾選/取消勾選
- 純標記功能，不影響計算

---

## 資料結構

```typescript
// 成員
interface Member {
    id: string;
    name: string;
}

// 消費紀錄
interface Expense {
    id: string;
    name: string;           // 消費名稱
    amount: number;         // 金額
    paidBy: string;         // 付款人 ID
    participants: string[]; // 參與者 ID 陣列
    description?: string;   // 備註（選填）
}

// 帳單
interface SplitBill {
    id: string;
    name: string;
    members: Member[];
    expenses: Expense[];
    serviceFeePercent: number;  // 服務費百分比，預設 0
    settledTransfers: string[]; // 已結清轉帳，格式 "fromId-toId"
    createdAt: string;          // ISO 日期字串
    updatedAt: string;          // ISO 日期字串
}
```

---

## 計算邏輯

### 步驟 1：計算每人應付金額

```
對於每筆消費：
  含服務費金額 = amount × (1 + serviceFeePercent / 100)
  每位參與者應付 = 含服務費金額 / 參與者人數
```

### 步驟 2：計算每人淨額

```
每人淨額 = 實付總額 - 應付總額

正數 = 別人欠他錢（債權人）
負數 = 他欠別人錢（債務人）
```

### 步驟 3：產生轉帳清單（餘額結算演算法）

**目標：** 最小化轉帳次數，讓結算更簡單

**實作策略：** 貪婪法（Greedy Approach）

**演算法步驟：**

```
1. 計算每人淨額（實付 - 應付）
2. 分成兩組：
   - 債權人（淨額 > 0）：別人欠他錢
   - 債務人（淨額 < 0）：他欠別人錢
3. 排序：債權人由大到小，債務人由小到大（絕對值大的優先）
4. 迴圈配對：
   a. 取最大債權人和最大債務人
   b. 轉帳金額 = min(債權, |債務|)
   c. 產生一筆轉帳：債務人 → 債權人
   d. 更新雙方餘額
   e. 餘額歸零者移出佇列
5. 重複直到所有餘額歸零
```

**範例：**

四人聚餐，消費如下：

| 品項 | 金額 | 付款人 | 參與者 |
|------|------|--------|--------|
| 晚餐 | $1200 | A | A, B, C, D |
| 酒水 | $400 | B | A, B, C, D |
| 甜點 | $200 | C | C, D |

**步驟 1 & 2：計算淨額**

| 成員 | 應付 | 實付 | 淨額 | 角色 |
|------|------|------|------|------|
| A | $300 + $100 = $400 | $1200 | +$800 | 債權人 |
| B | $300 + $100 = $400 | $400 | $0 | - |
| C | $300 + $100 + $100 = $500 | $200 | -$300 | 債務人 |
| D | $300 + $100 + $100 = $500 | $0 | -$500 | 債務人 |

**步驟 3：排序**
- 債權人：A (+$800)
- 債務人：D (-$500), C (-$300)

**步驟 4：配對轉帳**

| 回合 | 配對 | 轉帳 | A 餘額 | C 餘額 | D 餘額 |
|------|------|------|--------|--------|--------|
| 初始 | - | - | +800 | -300 | -500 |
| 1 | A ↔ D | D → A $500 | +300 | -300 | 0 ✓ |
| 2 | A ↔ C | C → A $300 | 0 ✓ | 0 ✓ | 0 ✓ |

**最終結果：只需 2 筆轉帳**
```
D → A $500
C → A $300
```

**為什麼用貪婪演算法？**
- 簡單直觀，易於實作
- 對於一般聚餐場景（< 10 人）效果很好
- 不保證全域最優解，但實務上差異極小

---

## UI 結構

### 頁面區塊

1. **帳單選擇器**
   - 下拉選單切換帳單
   - 新增帳單按鈕

2. **成員區塊**
   - 顯示成員 Chips
   - 輸入框 + 按鈕新增成員
   - 點 X 刪除成員

3. **服務費設定**
   - 數字輸入框（%）
   - 即時套用

4. **消費紀錄區塊**
   - 消費清單
   - 新增消費按鈕 → 開啟 Dialog
   - 每筆顯示：名稱、金額、付款人

5. **新增消費 Dialog**
   - 名稱輸入框
   - 金額輸入框
   - 付款人下拉選單
   - 參與者多選（Checkbox）

6. **結算結果區塊**
   - 驗算資訊（總額、服務費、每人明細）
   - 轉帳清單：`A → B $440 [結清✓]`
   - 點擊可 toggle 結清狀態

---

## 使用情境

### 情境 1：基本均分
> 三人聚餐，A 付了 $900

- 成員：A, B, C
- 消費：晚餐 $900，A 付款，參與者 A/B/C
- 結果：B → A $300, C → A $300

### 情境 2：部分分攤
> A 付了 $900，但 C 沒吃，不用分攤

- 成員：A, B, C
- 消費：晚餐 $900，A 付款，參與者 A/B
- 結果：B → A $450

### 情境 3：A 代付 B 的消費
> A 幫 B 買了 $200 的東西，只有 B 需要付

- 成員：A, B
- 消費：代購 $200，A 付款，參與者 B
- 結果：B → A $200

### 情境 4：含服務費
> 餐廳收 10% 服務費

- 服務費：10%
- 消費：$1000
- 實際計算金額：$1100

---

## 技術規格

### 儲存
- 使用 localStorage
- Key: `kayden-tools-split-bill`
- 未來可擴充至資料庫 API

### 狀態管理
- Zustand + persist middleware

### UI 框架
- Material UI (MUI)
- 響應式設計，支援手機

---

## 待實作項目

- [x] 資料結構定義
- [x] Zustand Store（CRUD）
- [x] 成員區塊 UI
- [x] 消費紀錄區塊 UI
- [x] 新增消費 Dialog
- [x] 服務費設定 UI
- [x] 結算計算邏輯
- [x] 結算結果顯示
- [x] 結清標記功能